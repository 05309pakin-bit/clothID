<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ClothID â€” à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<!-- TensorFlow.js + Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.8.6/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.5/dist/teachablemachine-image.min.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB3mNRyDrbGEYb7gBm2XTGLS5NSW14sTwA",
    authDomain: "clotheid-7df04.firebaseapp.com",
    projectId: "clotheid-7df04",
    storageBucket: "clotheid-7df04.firebasestorage.app",
    messagingSenderId: "905011651452",
    appId: "1:905011651452:web:e2c58e458356eccc583af9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  window._firebaseDB = db;
  window._firebaseStorage = storage;
  window._firebaseCollection = collection;
  window._firebaseAddDoc = addDoc;
  window._firebaseGetDocs = getDocs;
  window._firebaseQuery = query;
  window._firebaseOrderBy = orderBy;
  window._firebaseRef = ref;
  window._firebaseUploadString = uploadString;
  window._firebaseGetDownloadURL = getDownloadURL;
  window._firebaseReady = true;
  document.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c27;
    --border: #2a2a3d;
    --accent: #4f8ef7;
    --accent2: #a78bfa;
    --success: #34d399;
    --warning: #fbbf24;
    --danger: #f87171;
    --text: #e8e8f0;
    --text2: #8888aa;
    --font: 'Sarabun', sans-serif;
    --mono: 'Space Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.92);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .header-logo {
    font-family: var(--mono);
    font-size: 18px;
    color: var(--accent);
    letter-spacing: 2px;
    font-weight: 700;
  }
  .header-logo span { color: var(--accent2); }

  /* â”€â”€ Nav tabs â”€â”€ */
  .nav-tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .nav-tabs::-webkit-scrollbar { display: none; }
  .nav-tab {
    flex: 1; min-width: 80px;
    padding: 12px 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .nav-tab .tab-icon { font-size: 18px; display: block; margin-bottom: 2px; }

  /* â”€â”€ Pages â”€â”€ */
  .page { display: none; padding: 20px; }
  .page.active { display: block; }

  /* â”€â”€ Session page â”€â”€ */
  .session-status {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 12px;
  }
  .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--text2);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  .status-dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  .btn {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 24px;
    border-radius: 12px;
    border: none;
    font-family: var(--font);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #6ba0ff; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-success { background: var(--success); color: #0a0a0f; }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-warning { background: var(--warning); color: #0a0a0f; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }

  /* â”€â”€ Camera modal â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: #000;
    display: none; flex-direction: column;
    /* Force it to always be a column stack, never let video expand past viewport */
    overflow: hidden;
  }
  .modal-overlay.open { display: flex; }

  #cameraFeed {
    width: 100%;
    /* Fixed height so controls are never pushed off screen */
    height: calc(100dvh - 120px);
    max-height: calc(100dvh - 120px);
    object-fit: cover;
    background: #000;
    display: block;
    flex-shrink: 1;
    /* Critical: prevent iOS Safari from going native fullscreen */
    -webkit-playsinline: true;
  }
  .camera-controls {
    /* Always pinned at bottom, never hidden */
    flex-shrink: 0;
    height: 120px;
    background: #000;
    border-top: 1px solid rgba(255,255,255,0.15);
    padding: 0 30px;
    display: flex; align-items: center; justify-content: space-between;
    gap: 16px;
    /* Safe area for iPhone home bar */
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .shutter-btn {
    width: 72px; height: 72px; border-radius: 50%;
    border: 4px solid #fff;
    background: rgba(255,255,255,0.15);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    transition: all 0.15s;
    flex-shrink: 0;
    /* Make it tappable on mobile */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  .shutter-btn:active { transform: scale(0.88); background: rgba(255,255,255,0.45); }
  .camera-side-btn {
    width: 52px; height: 52px; border-radius: 50%;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff; font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .camera-side-btn:active { background: rgba(255,255,255,0.3); }
  canvas#captureCanvas { display: none; }

  /* â”€â”€ Item card â”€â”€ */
  .item-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 14px;
    position: relative;
  }
  .item-card-img {
    width: 100%; height: 200px;
    object-fit: cover;
    background: var(--surface2);
  }
  .item-card-body { padding: 14px; }
  .item-card-title {
    font-size: 16px; font-weight: 700;
    margin-bottom: 6px;
  }
  .item-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .badge {
    padding: 4px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
    font-family: var(--mono);
    letter-spacing: 0.5px;
  }
  .badge-blue { background: rgba(79,142,247,0.2); color: var(--accent); border: 1px solid rgba(79,142,247,0.4); }
  .badge-purple { background: rgba(167,139,250,0.2); color: var(--accent2); border: 1px solid rgba(167,139,250,0.4); }
  .badge-green { background: rgba(52,211,153,0.2); color: var(--success); border: 1px solid rgba(52,211,153,0.4); }
  .badge-yellow { background: rgba(251,191,36,0.2); color: var(--warning); border: 1px solid rgba(251,191,36,0.4); }
  .badge-red { background: rgba(248,113,113,0.2); color: var(--danger); border: 1px solid rgba(248,113,113,0.4); }
  .badge-gray { background: rgba(136,136,170,0.2); color: var(--text2); border: 1px solid rgba(136,136,170,0.4); }

  .confidence-bar {
    height: 4px; border-radius: 2px;
    background: var(--border);
    margin-top: 8px; overflow: hidden;
  }
  .confidence-fill {
    height: 100%; border-radius: 2px;
    background: var(--accent);
    transition: width 0.5s ease;
  }

  .flag-review {
    position: absolute; top: 10px; right: 10px;
    background: var(--warning);
    color: #0a0a0f;
    font-size: 11px; font-weight: 700;
    padding: 4px 8px; border-radius: 8px;
    font-family: var(--mono);
  }

  /* â”€â”€ Summary cards â”€â”€ */
  .summary-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 10px; margin: 16px 0;
  }
  .summary-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    text-align: center;
  }
  .summary-count {
    font-size: 32px; font-weight: 700;
    font-family: var(--mono);
    color: var(--accent);
    line-height: 1;
  }
  .summary-label { font-size: 12px; color: var(--text2); margin-top: 4px; }

  /* â”€â”€ Log page â”€â”€ */
  .log-session {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 14px;
    overflow: hidden;
  }
  .log-session-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer;
  }
  .log-session-title { font-weight: 700; font-size: 14px; }
  .log-session-meta { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .log-session-body { display: none; padding: 12px; }
  .log-session-body.open { display: block; }

  .log-thumb-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 8px; }
  .log-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; background: var(--surface2); }

  /* â”€â”€ Loading spinner â”€â”€ */
  .spinner {
    width: 40px; height: 40px; border-radius: 50%;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-overlay {
    position: fixed; inset: 0; z-index: 500;
    background: rgba(10,10,15,0.85);
    display: none; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
    backdrop-filter: blur(4px);
  }
  .loading-overlay.show { display: flex; }
  .loading-text { font-size: 14px; color: var(--text2); }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 20px;
    font-size: 13px; color: var(--text);
    z-index: 2000; opacity: 0;
    transition: all 0.3s;
    white-space: nowrap;
    max-width: 90vw;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* â”€â”€ Empty state â”€â”€ */
  .empty { text-align: center; padding: 40px 20px; color: var(--text2); }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }

  /* â”€â”€ Section title â”€â”€ */
  .section-title {
    font-size: 13px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--text2);
    margin-bottom: 12px; margin-top: 20px;
    font-family: var(--mono);
  }
  .section-title:first-child { margin-top: 0; }

  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

  /* â”€â”€ Bottom safe area â”€â”€ */
  .bottom-pad { height: 30px; }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ AI...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Camera Modal -->
<div class="modal-overlay" id="cameraModal">
  <video id="cameraFeed" autoplay playsinline muted></video>
  <canvas id="captureCanvas"></canvas>
  <div class="camera-controls">
    <button class="camera-side-btn" id="closeCameraBtn" title="à¸›à¸´à¸”">âœ•</button>
    <button class="shutter-btn" id="shutterBtn">ğŸ“·</button>
    <button class="camera-side-btn" id="flipCameraBtn" title="à¸ªà¸¥à¸±à¸šà¸à¸¥à¹‰à¸­à¸‡">ğŸ”„</button>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="header-logo">CLOTH<span>ID</span></div>
  <div style="font-size:12px;color:var(--text2);font-family:var(--mono);" id="modelStatus">â³ Loading...</div>
</div>

<!-- Nav Tabs -->
<div class="nav-tabs">
  <div class="nav-tab active" onclick="switchTab('scan')" id="tab-scan">
    <span class="tab-icon">ğŸ“·</span>à¸ªà¹à¸à¸™
  </div>
  <div class="nav-tab" onclick="switchTab('results')" id="tab-results">
    <span class="tab-icon">ğŸ‘•</span>à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
  </div>
  <div class="nav-tab" onclick="switchTab('summary')" id="tab-summary">
    <span class="tab-icon">ğŸ“Š</span>à¸ªà¸£à¸¸à¸›
  </div>
  <div class="nav-tab" onclick="switchTab('log')" id="tab-log">
    <span class="tab-icon">ğŸ—‚ï¸</span>à¸šà¸±à¸™à¸—à¸¶à¸
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCAN PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-scan">
  <div class="session-status">
    <div class="status-dot" id="sessionDot"></div>
    <div>
      <div style="font-weight:600;font-size:14px;" id="sessionStatusText">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸‹à¸ªà¸Šà¸±à¸™</div>
      <div style="font-size:12px;color:var(--text2);" id="sessionItemCount">à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸‹à¸ªà¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸à¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸¸à¸”</div>
    </div>
  </div>

  <div class="btn-group" id="noSessionBtns">
    <button class="btn btn-primary" onclick="startSession()">
      â–¶ à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸‹à¸ªà¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆ
    </button>
    <button class="btn btn-secondary" onclick="switchTab('log')">
      ğŸ—‚ï¸ à¸”à¸¹à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¹ˆà¸²
    </button>
  </div>

  <div class="btn-group" id="activeSessionBtns" style="display:none;">
    <button class="btn btn-primary" onclick="openCamera()">
      ğŸ“· à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¸Šà¸¸à¸”à¸–à¸±à¸”à¹„à¸›
    </button>
    <button class="btn btn-secondary" onclick="switchTab('results')">
      ğŸ‘• à¸”à¸¹à¸Šà¸¸à¸”à¹ƒà¸™à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸™à¸µà¹‰ (<span id="scanCount">0</span>)
    </button>
    <button class="btn btn-success" onclick="finishSession()">
      âœ… à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™ â€” à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥
    </button>
    <button class="btn btn-danger" onclick="cancelSession()">
      ğŸ—‘ï¸ à¸¢à¸à¹€à¸¥à¸´à¸à¹€à¸‹à¸ªà¸Šà¸±à¸™
    </button>
  </div>

  <div class="bottom-pad"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-results">
  <div id="resultsContainer">
    <div class="empty">
      <div class="empty-icon">ğŸ‘•</div>
      <div>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸Šà¸¸à¸”à¸—à¸µà¹ˆà¸ªà¹à¸à¸™</div>
      <div style="font-size:12px;margin-top:6px;">à¹„à¸›à¸—à¸µà¹ˆà¹à¸—à¹‡à¸š "à¸ªà¹à¸à¸™" à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™</div>
    </div>
  </div>
  <div class="bottom-pad"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUMMARY PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-summary">
  <div id="summaryContainer">
    <div class="empty">
      <div class="empty-icon">ğŸ“Š</div>
      <div>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸£à¸¸à¸›</div>
      <div style="font-size:12px;margin-top:6px;">à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¹€à¸‹à¸ªà¸Šà¸±à¸™à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸ªà¸£à¸¸à¸›</div>
    </div>
  </div>
  <div class="bottom-pad"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOG PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-log">
  <div class="section-title">à¸šà¸±à¸™à¸—à¸¶à¸à¸«à¸¥à¸±à¸à¸à¸²à¸™</div>
  <div id="logContainer">
    <div class="empty">
      <div class="empty-icon">ğŸ—‚ï¸</div>
      <div>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸™à¸—à¸¶à¸</div>
    </div>
  </div>
  <div class="bottom-pad"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/S2PvVNrNR/';
const VISION_API_KEY = 'AIzaSyDRLU30zCGqePZNOb1P196kC_17aPur4oU';

// Label mapping from model classes â†’ Thai display names + categories
const LABEL_MAP = {
  'pa_pants1': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™' },
  'pa_pants2': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™' },
  'pa_pants3': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™' },
  'pa_shirt1': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™' },
  'pa_shirts2': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™' },
  'pa_shirt3': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™' },
  'ac_shirt1': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²' },
  'ac_shirt2': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²' },
  'PE_shirt1': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸² (PE)', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²' },
  'PE_shirt2': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸² (PE)', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²' },
  'PE_shirt3': { th: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸² (PE)', cat: 'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²' },
  'PE_pants1': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡' },
  'PE_pants2': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡' },
  'PE_pants3': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡' },
  'stu_shirt1': { th: 'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™', cat: 'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™' },
  'stu_shirt2': { th: 'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™', cat: 'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™' },
  'Stu_shirt3': { th: 'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™', cat: 'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™' },
  'stu_shorts1': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™' },
  'stu_shorts2': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™' },
  'stu_shorts3': { th: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™', cat: 'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™' },
  'bg':  { th: 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡', cat: 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡' },
  'bg1': { th: 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡', cat: 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡' },
  'bg2': { th: 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡', cat: 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡' },
};

const CAT_COLORS = {
  'à¸Šà¸¸à¸”à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™': 'badge-blue',
  'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™': 'badge-blue',
  'à¹€à¸ªà¸·à¹‰à¸­à¸à¸µà¸¬à¸²': 'badge-green',
  'à¸à¸²à¸‡à¹€à¸à¸‡à¸§à¸­à¸£à¹Œà¸¡': 'badge-green',
  'à¹€à¸ªà¸·à¹‰à¸­à¸™à¸­à¸™': 'badge-purple',
  'à¸à¸²à¸‡à¹€à¸à¸‡à¸™à¸­à¸™': 'badge-purple',
  'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡': 'badge-gray',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let model = null;
let session = null; // { id, items: [], startedAt }
let cameraStream = null;
let facingMode = 'environment';
let firebaseReady = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  showLoading('à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ AI...');
  // Retry up to 3 times â€” helps on slow mobile connections
  for (let attempt = 1; attempt <= 3; attempt++) {
    try {
      showLoadingText(`à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ AI... (à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ ${attempt})`);
      model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
      document.getElementById('modelStatus').textContent = 'âœ… à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™';
      showToast('âœ… à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ AI à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
      break; // success
    } catch(e) {
      console.error(`Model load attempt ${attempt} failed:`, e);
      if (attempt === 3) {
        document.getElementById('modelStatus').textContent = 'âŒ à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ';
        document.getElementById('modelStatus').style.color = 'var(--danger)';
        showToast('âŒ à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¸à¸£à¸¸à¸“à¸²à¸£à¸µà¹€à¸Ÿà¸£à¸Š');
      } else {
        await new Promise(r => setTimeout(r, 1500)); // wait before retry
      }
    }
  }
  hideLoading();

  // Firebase
  document.addEventListener('firebaseReady', () => {
    firebaseReady = true;
    loadLog();
  });
  if (window._firebaseReady) { firebaseReady = true; loadLog(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSession() {
  session = {
    id: 'S' + Date.now(),
    items: [],
    startedAt: new Date().toISOString(),
  };
  updateSessionUI();
  openCamera();
}

function cancelSession() {
  if (!confirm('à¸¢à¸à¹€à¸¥à¸´à¸à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸™à¸µà¹‰?')) return;
  session = null;
  updateSessionUI();
  renderResults();
}

async function finishSession() {
  if (!session || session.items.length === 0) {
    showToast('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸Šà¸¸à¸”à¹ƒà¸™à¹€à¸‹à¸ªà¸Šà¸±à¸™');
    return;
  }
  showLoading('à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸«à¸¥à¸±à¸à¸à¸²à¸™...');
  await saveSessionToFirebase(session);
  hideLoading();
  showToast('à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
  renderSummary(session);
  session = null;
  updateSessionUI();
  renderResults();
  loadLog();
  switchTab('summary');
}

function updateSessionUI() {
  const hasSession = !!session;
  document.getElementById('noSessionBtns').style.display = hasSession ? 'none' : 'flex';
  document.getElementById('activeSessionBtns').style.display = hasSession ? 'flex' : 'none';
  document.getElementById('sessionDot').className = 'status-dot' + (hasSession ? ' active' : '');
  document.getElementById('sessionStatusText').textContent = hasSession ? `à¹€à¸‹à¸ªà¸Šà¸±à¸™ ${session.id}` : 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸‹à¸ªà¸Šà¸±à¸™';
  document.getElementById('sessionItemCount').textContent = hasSession
    ? `à¸ªà¹à¸à¸™à¹à¸¥à¹‰à¸§ ${session.items.length} à¸Šà¸¸à¸”`
    : 'à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸‹à¸ªà¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸à¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸¸à¸”';
  document.getElementById('scanCount').textContent = session ? session.items.length : 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openCamera() {
  if (!model) { showToast('à¹‚à¸¡à¹€à¸”à¸¥à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡'); return; }
  const modal = document.getElementById('cameraModal');
  modal.classList.add('open');
  await startCameraStream();
}

async function startCameraStream() {
  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); }
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode,
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });
    const videoEl = document.getElementById('cameraFeed');
    videoEl.srcObject = cameraStream;
    // Critical for iOS: must set these attributes to prevent native fullscreen
    videoEl.setAttribute('playsinline', true);
    videoEl.setAttribute('webkit-playsinline', true);
    videoEl.muted = true;
    await videoEl.play();
  } catch(e) {
    showToast('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰: ' + e.message);
    closeCamera();
  }
}

function closeCamera() {
  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  document.getElementById('cameraModal').classList.remove('open');
  document.getElementById('cameraFeed').srcObject = null;
}

document.getElementById('closeCameraBtn').onclick = closeCamera;
document.getElementById('flipCameraBtn').onclick = async () => {
  facingMode = facingMode === 'environment' ? 'user' : 'environment';
  await startCameraStream();
};

document.getElementById('shutterBtn').onclick = capturePhoto;

async function capturePhoto() {
  const video = document.getElementById('cameraFeed');
  const canvas = document.getElementById('captureCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

  closeCamera();

  if (!session) {
    showToast('à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸‹à¸ªà¸Šà¸±à¸™à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆ');
    return;
  }

  showLoading('à¸à¸³à¸¥à¸±à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸Šà¸¸à¸”...');

  // 1. Classify with Teachable Machine
  const classResult = await classifyImage(canvas);

  // 2. OCR name with Google Vision
  showLoadingText('à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡...');
  const ocrResult = await detectNameOCR(dataUrl);

  const item = {
    id: 'I' + Date.now(),
    imageDataUrl: dataUrl,
    classification: classResult,
    owner: ocrResult,
    timestamp: new Date().toISOString(),
    flagged: ocrResult.flagged,
  };

  session.items.push(item);
  updateSessionUI();
  renderResults();
  hideLoading();
  switchTab('results');
  showToast(ocrResult.flagged ? 'âš ï¸ à¸•à¸£à¸§à¸ˆà¸à¸šà¸Šà¸¸à¸” â€” à¸Šà¸·à¹ˆà¸­à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š' : 'âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASSIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function classifyImage(canvas) {
  try {
    const predictions = await model.predict(canvas);
    // Filter out background
    const clothePreds = predictions.filter(p => !p.className.startsWith('bg'));
    clothePreds.sort((a, b) => b.probability - a.probability);
    const top = clothePreds[0];
    const mapped = LABEL_MAP[top.className] || { th: top.className, cat: 'à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸š' };
    return {
      raw: top.className,
      label: mapped.th,
      category: mapped.cat,
      confidence: top.probability,
      all: predictions.map(p => ({
        raw: p.className,
        label: (LABEL_MAP[p.className] || {th: p.className}).th,
        prob: p.probability
      }))
    };
  } catch(e) {
    return { raw: 'error', label: 'à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹„à¸¡à¹ˆà¹„à¸”à¹‰', category: 'à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸š', confidence: 0, all: [] };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OCR â€” Google Cloud Vision
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function detectNameOCR(dataUrl) {
  try {
    const base64 = dataUrl.split(',')[1];
    const body = {
      requests: [{
        image: { content: base64 },
        features: [{ type: 'TEXT_DETECTION', maxResults: 1 }],
        imageContext: { languageHints: ['th', 'en'] }
      }]
    };
    const res = await fetch(
      `https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`,
      { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
    );
    const data = await res.json();
    const annotations = data.responses?.[0]?.textAnnotations;
    if (!annotations || annotations.length === 0) {
      return { name: null, raw: '', flagged: true, reason: 'à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸™à¸ à¸²à¸' };
    }
    const fullText = annotations[0].description.trim();
    // Try to extract Thai name (typically 2+ Thai words)
    const thaiNameMatch = extractThaiName(fullText);
    if (thaiNameMatch) {
      return { name: thaiNameMatch, raw: fullText, flagged: false };
    } else {
      return { name: null, raw: fullText, flagged: true, reason: 'à¹„à¸¡à¹ˆà¸à¸šà¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™ â€” à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š' };
    }
  } catch(e) {
    return { name: null, raw: '', flagged: true, reason: 'OCR à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: ' + e.message };
  }
}

function extractThaiName(text) {
  // Match Thai text patterns that look like a name (2 Thai words)
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  for (const line of lines) {
    // Thai name = typically 2 Thai words, 4-20 chars each
    const match = line.match(/^[\u0E00-\u0E7F\s\.]{4,40}$/);
    if (match) {
      const words = line.trim().split(/\s+/);
      if (words.length >= 2) return line.trim();
    }
  }
  // Try finding Thai substring in mixed text
  const thaiMatch = text.match(/[\u0E00-\u0E7F]{3,}(?:\s+[\u0E00-\u0E7F]{3,})+/);
  if (thaiMatch) return thaiMatch[0].trim();
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults() {
  const container = document.getElementById('resultsContainer');
  const items = session ? session.items : [];
  if (items.length === 0) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ‘•</div><div>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸Šà¸¸à¸”à¸—à¸µà¹ˆà¸ªà¹à¸à¸™</div><div style="font-size:12px;margin-top:6px;">à¹„à¸›à¸—à¸µà¹ˆà¹à¸—à¹‡à¸š "à¸ªà¹à¸à¸™" à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™</div></div>`;
    return;
  }
  container.innerHTML = items.slice().reverse().map((item, i) => renderItemCard(item, i)).join('');
}

function renderItemCard(item, i) {
  const conf = Math.round(item.classification.confidence * 100);
  const catColor = CAT_COLORS[item.classification.category] || 'badge-gray';
  const ownerBadge = item.owner.name
    ? `<span class="badge badge-green">ğŸ‘¤ ${item.owner.name}</span>`
    : `<span class="badge badge-yellow">âš ï¸ à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</span>`;
  const flagEl = item.flagged ? `<div class="flag-review">âš ï¸ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</div>` : '';
  const ts = new Date(item.timestamp).toLocaleTimeString('th-TH');
  return `
    <div class="item-card">
      ${flagEl}
      <img class="item-card-img" src="${item.imageDataUrl}" alt="à¸Šà¸¸à¸”">
      <div class="item-card-body">
        <div class="item-card-title">${item.classification.label}</div>
        <div style="font-size:12px;color:var(--text2);">ğŸ“… ${ts}</div>
        <div class="item-meta">
          <span class="badge ${catColor}">${item.classification.category}</span>
          <span class="badge badge-blue" style="font-family:var(--mono);">${conf}%</span>
          ${ownerBadge}
        </div>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width:${conf}%"></div>
        </div>
        ${item.owner.flagged && item.owner.reason ? `<div style="font-size:11px;color:var(--warning);margin-top:6px;">âš ï¸ ${item.owner.reason}</div>` : ''}
        ${item.owner.raw ? `<div style="font-size:11px;color:var(--text2);margin-top:4px;">OCR: ${item.owner.raw.substring(0,60)}${item.owner.raw.length > 60 ? '...' : ''}</div>` : ''}
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary(sess) {
  const items = sess.items;
  const cats = {};
  const owners = {};
  let flagged = 0;

  items.forEach(item => {
    const cat = item.classification.category;
    cats[cat] = (cats[cat] || 0) + 1;
    if (item.owner.name) owners[item.owner.name] = (owners[item.owner.name] || 0) + 1;
    if (item.flagged) flagged++;
  });

  const catRows = Object.entries(cats)
    .filter(([k]) => k !== 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡')
    .sort((a, b) => b[1] - a[1])
    .map(([k, v]) => `
      <div class="summary-card">
        <div class="summary-count">${v}</div>
        <div class="summary-label">${k}</div>
      </div>
    `).join('');

  const ownerRows = Object.entries(owners).length > 0
    ? Object.entries(owners).map(([name, count]) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
          <span style="font-size:14px;">ğŸ‘¤ ${name}</span>
          <span class="badge badge-blue" style="font-family:var(--mono);">${count} à¸Šà¸´à¹‰à¸™</span>
        </div>
      `).join('')
    : '<div style="color:var(--text2);font-size:13px;">à¹„à¸¡à¹ˆà¸à¸šà¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡</div>';

  document.getElementById('summaryContainer').innerHTML = `
    <div class="section-title">à¸›à¸£à¸°à¹€à¸ à¸—à¸Šà¸¸à¸”</div>
    <div class="summary-grid">${catRows || '<div style="color:var(--text2)">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</div>'}</div>
    <div class="summary-card" style="margin-bottom:10px">
      <div class="summary-count">${items.length}</div>
      <div class="summary-label">à¸Šà¸¸à¸”à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
    </div>
    ${flagged > 0 ? `<div class="summary-card" style="border-color:var(--warning);">
      <div class="summary-count" style="color:var(--warning);">${flagged}</div>
      <div class="summary-label" style="color:var(--warning);">à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</div>
    </div>` : ''}
    <hr class="divider">
    <div class="section-title">à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¸Šà¸¸à¸”</div>
    ${ownerRows}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveSessionToFirebase(sess) {
  if (!firebaseReady) { showToast('Firebase à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡'); return; }
  try {
    const db = window._firebaseDB;
    const storage = window._firebaseStorage;

    // Upload images and get URLs
    const itemsToSave = await Promise.all(sess.items.map(async (item) => {
      let imageUrl = null;
      try {
        const storageRef = window._firebaseRef(storage, `evidence/${sess.id}/${item.id}.jpg`);
        await window._firebaseUploadString(storageRef, item.imageDataUrl, 'data_url');
        imageUrl = await window._firebaseGetDownloadURL(storageRef);
      } catch(e) { console.warn('Image upload failed', e); }

      return {
        id: item.id,
        imageUrl,
        classification: item.classification.label,
        category: item.classification.category,
        confidence: item.classification.confidence,
        ownerName: item.owner.name || null,
        ownerRaw: item.owner.raw || null,
        flagged: item.flagged,
        flagReason: item.owner.reason || null,
        timestamp: item.timestamp,
      };
    }));

    await window._firebaseAddDoc(
      window._firebaseCollection(db, 'sessions'),
      {
        sessionId: sess.id,
        startedAt: sess.startedAt,
        finishedAt: new Date().toISOString(),
        totalItems: sess.items.length,
        items: itemsToSave,
      }
    );
  } catch(e) {
    showToast('à¸šà¸±à¸™à¸—à¸¶à¸ Firebase à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + e.message);
    console.error(e);
  }
}

async function loadLog() {
  if (!firebaseReady) return;
  try {
    const db = window._firebaseDB;
    const q = window._firebaseQuery(
      window._firebaseCollection(db, 'sessions'),
      window._firebaseOrderBy('finishedAt', 'desc')
    );
    const snap = await window._firebaseGetDocs(q);
    const sessions = [];
    snap.forEach(doc => sessions.push(doc.data()));
    renderLog(sessions);
  } catch(e) {
    console.warn('Load log failed', e);
  }
}

function renderLog(sessions) {
  const container = document.getElementById('logContainer');
  if (sessions.length === 0) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ—‚ï¸</div><div>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸™à¸—à¸¶à¸</div></div>`;
    return;
  }
  container.innerHTML = sessions.map((s, idx) => {
    const date = new Date(s.finishedAt).toLocaleString('th-TH');
    const flagged = s.items.filter(i => i.flagged).length;
    const cats = {};
    s.items.forEach(i => { cats[i.category] = (cats[i.category] || 0) + 1; });
    const catSummary = Object.entries(cats)
      .filter(([k]) => k !== 'à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡')
      .map(([k,v]) => `${k}: ${v}`)
      .join(', ');

    const thumbs = s.items
      .filter(i => i.imageUrl)
      .slice(0, 9)
      .map(i => `<img class="log-thumb" src="${i.imageUrl}" alt="">`)
      .join('');

    return `
      <div class="log-session">
        <div class="log-session-header" onclick="toggleLog(${idx})">
          <div>
            <div class="log-session-title">ğŸ“¦ ${s.sessionId}</div>
            <div class="log-session-meta">ğŸ• ${date} Â· ${s.totalItems} à¸Šà¸¸à¸” ${flagged > 0 ? `Â· âš ï¸ ${flagged} à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š` : ''}</div>
            <div class="log-session-meta" style="margin-top:2px;">${catSummary}</div>
          </div>
          <span style="color:var(--text2);font-size:18px;">â€º</span>
        </div>
        <div class="log-session-body" id="logBody${idx}">
          ${s.items.map(i => `
            <div style="padding:8px 0;border-bottom:1px solid var(--border);">
              <div style="display:flex;gap:10px;align-items:flex-start;">
                ${i.imageUrl ? `<img src="${i.imageUrl}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;flex-shrink:0;">` : '<div style="width:56px;height:56px;background:var(--surface2);border-radius:8px;flex-shrink:0;"></div>'}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:600;font-size:13px;">${i.classification}</div>
                  <div style="font-size:11px;color:var(--text2);">
                    ${i.ownerName ? `ğŸ‘¤ ${i.ownerName}` : `âš ï¸ ${i.flagReason || 'à¸•à¹‰à¸­à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š'}`}
                  </div>
                  <div style="font-size:11px;color:var(--text2);">${Math.round(i.confidence*100)}% à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
}

function toggleLog(idx) {
  const el = document.getElementById('logBody' + idx);
  el.classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'log' && firebaseReady) loadLog();
}

function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...';
  document.getElementById('loadingOverlay').classList.add('show');
}
function showLoadingText(text) {
  document.getElementById('loadingText').textContent = text;
}
function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
